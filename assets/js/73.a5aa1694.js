(window.webpackJsonp=window.webpackJsonp||[]).push([[73],{405:function(s,t,a){"use strict";a.r(t);var n=a(25),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"硬件的效率问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#硬件的效率问题"}},[s._v("#")]),s._v(" 硬件的效率问题")]),s._v(" "),a("p",[s._v("尽管硬件不断发展，但是核心问题一直存在："),a("strong",[s._v("CPU、内存、I/O 设备，三者速度有数量级的差距")]),s._v("，为了平衡三者的速度差异，主要有以下几点措施：")]),s._v(" "),a("ol",[a("li",[s._v("CPU 与内存之间增加了"),a("strong",[s._v("高速缓存")]),s._v("，均衡 CPU 与内存差异")]),s._v(" "),a("li",[s._v("操作系统提出了"),a("strong",[s._v("进程、线程")]),s._v("，用于分时复用 CPU，均衡 CPU 与 I/O 设备差异")]),s._v(" "),a("li",[s._v("编译器"),a("strong",[s._v("优化指令执行顺序")]),s._v("，充分利用缓存（CPU 寄存器，CPU 高速缓存）")])]),s._v(" "),a("p",[s._v("这些措施虽然平衡了三者速度的差异，但也带来了问题")]),s._v(" "),a("h3",{attrs:{id:"缓存导致的可见性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#缓存导致的可见性问题"}},[s._v("#")]),s._v(" 缓存导致的可见性问题")]),s._v(" "),a("p",[s._v("多线程环境下，一个线程修改了共享变量的值，其他线程能够立即看到，称为"),a("strong",[s._v("可见性")]),s._v("（Visibility）")]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("单核场景下")]),s._v("：所有线程在一个 CPU 上执行，所有线程都操作同一个 CPU 缓存，因此不存在可见性问题")]),s._v(" "),a("li",[a("strong",[s._v("多核环境下")]),s._v("：每个 CPU 内核拥有自己的缓存，当多个线程在不同 CPU 上运行且涉及同一共享变量时，A 线程对 CPU-1 缓存的操作，对 CPU-2 上运行的 B 线程就不具备可见性了，也称为"),a("strong",[s._v("缓存一致性问题")])])]),s._v(" "),a("p",[s._v("因此，需要各个处理器访问缓存时都遵循一些协议，在读写时要根据协议进行操作，来维护缓存的一致性，比如 MESI 协议")]),s._v(" "),a("div",{attrs:{align:"center"}},[a("img",{staticStyle:{zoom:"70%"},attrs:{src:"/img/Java/JMMCPU.png"}})]),s._v(" "),a("h3",{attrs:{id:"线程切换导致的原子性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线程切换导致的原子性问题"}},[s._v("#")]),s._v(" 线程切换导致的原子性问题")]),s._v(" "),a("p",[s._v("一个或多个操作在 CPU 执行过程中不被中断的特性称为"),a("strong",[s._v("原子性")]),s._v("（Atomicity）")]),s._v(" "),a("p",[s._v("早期 OS 基于进程调度 CPU，现代 OS 通常基于更轻量级的线程来调度")]),s._v(" "),a("p",[s._v("对于高级语言来说，一条指令往往需要"),a("strong",[s._v("多条 CPU 指令")]),s._v("来执行，例如 counter += 1 需要 3 条指令来完成：")]),s._v(" "),a("ol",[a("li",[s._v("将变量 counter 从内存加载到 CPU 寄存器")]),s._v(" "),a("li",[s._v("在寄存器中执行 +1 操作")]),s._v(" "),a("li",[s._v("将寄存器结果写回内存中（或写入 CPU 缓存中）")])]),s._v(" "),a("p",[s._v("CPU 在进行任务调度时，不同任务的切换可能发生在任何一条 CPU 指令之后，因此当两个线程同时执行 counter += 1 时，可能出现下列情景：")]),s._v(" "),a("ol",[a("li",[s._v("counter 初始化为 0")]),s._v(" "),a("li",[s._v("A 线程在执行完指令 1 和 2 后，线程切换为 B 线程执行")]),s._v(" "),a("li",[s._v("B 执行完指令 1，2，3 后，更新 counter 为 1，线程切换为 A 执行")]),s._v(" "),a("li",[s._v("A 执行指令 3，更新 counter 为 1")])]),s._v(" "),a("p",[s._v("这种错误出现的原因，就在于 CPU 能保证的原子操作是 "),a("strong",[s._v("CPU 指令级别的")]),s._v("，而不是高级语言级别")]),s._v(" "),a("h3",{attrs:{id:"指令重排序导致的有序性问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#指令重排序导致的有序性问题"}},[s._v("#")]),s._v(" 指令重排序导致的有序性问题")]),s._v(" "),a("p",[s._v("程序按照代码的先后顺序执行，称为"),a("strong",[s._v("有序性")]),s._v("（Ordering）")]),s._v(" "),a("p",[s._v("为了充分利用 CPU 内部运算单元高速缓存，编译器和处理器常常会对指令进行"),a("strong",[s._v("重排序")]),s._v("：")]),s._v(" "),a("ol",[a("li",[s._v("编译器优化的重排序：编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序")]),s._v(" "),a("li",[s._v("指令级并行的重排序：现代 CPU 采用指令级并行技术，如果不存在数据依赖，可以多条指令重叠执行")]),s._v(" "),a("li",[s._v("内存系统的重排序：由于 CPU 使用缓存和读/写缓冲区，使得 load/store 操作看上去可能是在乱序执行")])]),s._v(" "),a("div",{attrs:{align:"center"}},[a("img",{staticStyle:{zoom:"100%"},attrs:{src:"/img/Java/Reorder.png"}})]),s._v(" "),a("ul",[a("li",[a("strong",[s._v("单核环境下")]),s._v("：重排序是提高 CPU 运算速度的一种优化，保证结果与顺序执行相同（as - if - serial）")]),s._v(" "),a("li",[a("strong",[s._v("多核环境下")]),s._v("：如果一个线程的计算任务依赖另一个线程计算任务的中间结果，则代码的顺序性无法保证执行的顺序性，最终的结果也会不同于逻辑结果")])]),s._v(" "),a("details",[a("summary",[s._v("编译器级别 - 无依赖关系指令")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 两个线程，一个执行 writer，一个执行 reader\n * 正常情况：A 执行完成后，才会执行 D\n * 重排序后：A 和 B 无依赖关系，因此 B 可能先于 A 执行，导致 D 也先于 A 执行\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ReorderDemo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" counter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("writer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        counter "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 1")]),s._v("\n        flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 2")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("reader")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("flag"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 3")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("counter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//4")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])])]),s._v(" "),a("details",[a("summary",[s._v("指令级别 - 双重检查创建单例对象")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 双重 null 检查创建单例对象\n * 正常情况：\n *  1. 线程 A，线程 B 同时调用 getInstance()\n *  2. 同时发现 instance == null，竞争对 Singleton.class 加锁\n *  3，JVM 保证只有一个线程成功，假设 A 成功\n *  4. A 创建一个 Singleton 实例，释放锁\n *  5. B 获得锁，且发现 instance != null，不会重复创建实例\n *\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Singleton")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Singleton")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Singleton")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getInstance")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("synchronized")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Singleton")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("instance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("==")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("null")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n                    instance "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Singleton")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" instance"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br")])])])])}),[],!1,null,null,null);t.default=e.exports}}]);